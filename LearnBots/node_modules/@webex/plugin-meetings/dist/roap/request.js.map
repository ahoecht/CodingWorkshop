{"version":3,"sources":["request.js"],"names":["RoapRequest","localSdp","reachabilityData","window","localStorage","getItem","REACHABILITY","reachabilityResult","JSON","parse","length","reachability","e","LoggerProxy","logger","error","options","info","roapMessage","resolve","then","deviceUrl","webex","internal","device","url","body","usingResource","resourceId","correlationId","localMedias","attachRechabilityData","audioMuted","videoMuted","locusUrl","PARTICIPANT","sipUrl","services","locusServiceUrl","LOCI","CALL","invitee","address","sipTarget","ParameterError","request","method","HTTP_VERBS","POST","uri","res","locus","roapSeq","seq","id","split","pop","fullState","lastActive","catch","err","locusSelfUrl","mediaId","meetingId","mediaUrl","MEDIA","messageType","Metrics","postEvent","event","eventType","MEDIA_REQUEST","PUT","deviceType","config","meetings","audioVideo","MEDIA_RESPONSE","mediaConnection","mediaConnections","statusCode","data","parseLocusError","StatelessWebexPlugin"],"mappings":"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","file":"request.js","sourcesContent":["\n/* global window */\nimport {StatelessWebexPlugin} from '@webex/webex-core';\n\nimport LoggerProxy from '../common/logs/logger-proxy';\nimport {\n  PARTICIPANT,\n  LOCI,\n  CALL,\n  MEDIA,\n  HTTP_VERBS,\n  REACHABILITY\n} from '../constants';\nimport Metrics from '../metrics';\nimport {eventType} from '../metrics/config';\nimport ParameterError from '../common/errors/parameter';\n/**\n * @class RoapRequest\n */\nexport default class RoapRequest extends StatelessWebexPlugin {\n  /**\n   * Joins a meeting via ROAP\n   * @param {Object} options\n   * @returns {Promise} returns a promise that resolves/rejects whatever the request does\n   */\n\n\n  attachRechabilityData(localSdp) {\n    const reachabilityData = window.localStorage.getItem(REACHABILITY.localStorage);\n\n    if (reachabilityData) {\n      try {\n        const reachabilityResult = JSON.parse(reachabilityData);\n\n        /* istanbul ignore else */\n        if (reachabilityResult && Object.keys(reachabilityResult).length) {\n          localSdp.reachability = reachabilityResult;\n        }\n      }\n      catch (e) {\n        LoggerProxy.logger.error(`RoapRequest->attachReachabilityData#Error in parsing reachability data: ${e}`);\n      }\n    }\n\n    return localSdp;\n  }\n\n  joinMeetingWithRoap(options) {\n    LoggerProxy.logger.info('RoapRequest->joinMeetingWithRoap#Join locus with roap');\n    LoggerProxy.logger.info(`RoapRequest->joinMeetingWithRoap#Clocal SDP: ${options.roapMessage}`);\n\n    return Promise.resolve().then(() => {\n      const deviceUrl = this.webex.internal.device.url;\n      let url = '';\n\n      const body = {\n        deviceUrl,\n        usingResource: options.resourceId || null,\n        correlationId: options.correlationId,\n        localMedias: [\n          {\n            localSdp: JSON.stringify(this.attachRechabilityData({\n              roapMessage: options.roapMessage,\n              audioMuted: false,\n              videoMuted: false\n            }))\n          }\n        ]\n      };\n\n      if (options.locusUrl) {\n        url = `${options.locusUrl}/${PARTICIPANT}`;\n      }\n      else if (options.sipUrl) {\n        url = `${this.webex.internal.device.services.locusServiceUrl}/${LOCI}/${CALL}`;\n        body.invitee = {\n          address: options.sipTarget\n        };\n      }\n      else {\n        throw new ParameterError('Must provide a locusUrl or sipTarget');\n      }\n\n      return this.webex\n        .request({\n          method: HTTP_VERBS.POST,\n          uri: url,\n          body\n        })\n        .then((res) => {\n          const {locus} = res.body;\n\n          locus.roapSeq = options.roapMessage.seq;\n          locus.id = locus.url.split('/').pop();\n          LoggerProxy.logger.info(`RoapRequest->joinMeetingWithRoap#Joined locus [${locus.id}][${locus.fullState.lastActive}]`);\n\n          return locus;\n        })\n        .catch((err) => {\n          LoggerProxy.logger.error(`RoapRequest->joinMeetingWithRoap#failed with error: ${err}`);\n          throw err;\n        });\n    });\n  }\n\n  /**\n   * Sends a ROAP message\n   * @param {Object} options\n   * @param {String} options.roapMessage\n   * @param {String} options.locusId\n   * @param {String} options.locusSelfId\n   * @param {String} options.mediaId\n   * @param {String} options.correlationId\n   * @returns {Promise} returns the response/failure of the request\n   */\n  sendRoap(options) {\n    const {\n      roapMessage, locusSelfUrl, mediaId, correlationId, meetingId\n    } = options;\n\n    if (!mediaId) {\n      LoggerProxy.logger.info('RoapRequest->sendRoap#Race Condition /call mediaID not present');\n    }\n\n    const mediaUrl = `${locusSelfUrl}/${MEDIA}`;\n    const deviceUrl = this.webex.internal.device.url;\n\n    LoggerProxy.logger.info(`RoapRequest->sendRoap#${mediaUrl} \\n ${roapMessage.messageType} \\n seq:${roapMessage.seq}`);\n\n    Metrics.postEvent({event: eventType.MEDIA_REQUEST, meetingId});\n\n    return this.webex\n      .request({\n        uri: mediaUrl,\n        method: HTTP_VERBS.PUT,\n        body: {\n          device: {\n            url: deviceUrl,\n            deviceType: this.config.meetings.deviceType\n          },\n          correlationId,\n          localMedias: [\n            {\n              localSdp: JSON.stringify(this.attachRechabilityData({\n                roapMessage,\n                // eslint-disable-next-line no-warning-comments\n                // TODO: check whats the need for video and audiomute\n                audioMuted: !!options.audioMuted,\n                videoMuted: !!options.audioVideo\n              })),\n              mediaId: options.mediaId\n            }\n          ]\n        }\n      })\n      .then((res) => {\n        Metrics.postEvent({event: eventType.MEDIA_RESPONSE, meetingId});\n\n        // always it will be the first mediaConnection Object\n        const mediaConnection = res.body.mediaConnections && res.body.mediaConnections.length > 0 && res.body.mediaConnections[0];\n\n        LoggerProxy.logger.info(\n          `RoapRequest->sendRoap#:response:${JSON.stringify(mediaConnection, null, 2)}'\\n StatusCode:'${res.statusCode}`\n        );\n        const {locus} = res.body;\n\n        locus.roapSeq = options.roapMessage.seq;\n\n        return locus;\n      })\n      .catch((err) => {\n        Metrics.postEvent({event: eventType.MEDIA_RESPONSE, meetingId, data: {error: Metrics.parseLocusError(err, true)}});\n        LoggerProxy.logger.error(`RoapRequest->sendRoap#Error:${JSON.stringify(err, null, 2)}`);\n        LoggerProxy.logger.error(\n          `RoapRequest->sendRoapRequest#errorBody:${JSON.stringify(roapMessage, null, 2)} + '\\\\n mediaId:'${options.mediaId}`\n        );\n        throw err;\n      });\n  }\n}\n"]}