{"version":3,"sources":["stats.js"],"names":["MeetingStats","attrs","options","optionalCreateOptions","namespace","MEETINGS","peerConnection","RTCRtpDirection","history","stream","filter","events","id","populate","withHistory","media","withFilter","withStream","withId","onClose","TypeError","onEvent","withEventsHistory","withEvents","onData","data","add","event","cbFn","on","STATS","DATA","filtered","doHistory","doEvents","END","err","StatsError","cb","StatsEvents","setEvents","StatsHistory","config","stats","historyMax","setHistory","transceiverDirection","StatsStream","rTCRtpDirection","interval","setStream","setFilter","StatsFilter","getStream","pipe","getFilter","setId","uuid","v4","StatelessWebexPlugin"],"mappings":"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","file":"stats.js","sourcesContent":["import {StatelessWebexPlugin} from '@webex/webex-core';\nimport {isFunction} from 'lodash';\nimport {uuid} from 'uuid';\n\nimport {\n  MEETINGS,\n  STATS\n} from '../constants';\nimport StatsHistory from '../stats/history';\nimport StatsStream from '../stats/stream';\nimport StatsFilter from '../stats/filter';\nimport StatsEvents from '../stats/events';\nimport StatsError from '../common/errors/stats';\n\n/**\n * @class MeetingStats\n */\nexport default class MeetingStats extends StatelessWebexPlugin {\n  namespace = MEETINGS;\n\n  /**\n   * @param {Object} attrs\n   * @param {Object} options\n   * @param {Object} [optionalCreateOptions]\n   * @param {Boolean} optionalCreateOptions.history\n   * @param {RTCRtpSender|RTCRtpReceiver} optionalCreateOptions.stream\n   * @param {RTCRtpSender|RTCRtpReceiver} optionalCreateOptions.filter\n   * @param {RTCPeerConnection} optionalCreateOptions.media\n   * @param {String} optionalCreateOptions.id\n   * @param {Function} optionalCreateOptions.onClose\n   * @param {Function} optionalCreateOptions.onEvent\n   * @param {Function} optionalCreateOptions.onData\n   * if using filter or stream, media must also exist\n   */\n  constructor(attrs, options, optionalCreateOptions) {\n    super({}, options);\n    this.attrs = attrs;\n    this.options = options;\n    // what this stats object is configured to work with\n    /**\n     * @instance\n     * @type {RTCPeerConnection}\n     * @private\n     * @memberof MeetingStats\n     */\n    this.peerConnection = null;\n    /**\n     * @instance\n     * @type {RTCRtpSender|RTCRtpReceiver}\n     * @private\n     * @memberof MeetingStats\n     */\n    this.RTCRtpDirection = null;\n    // usable values\n    /**\n     * @instance\n     * @type {StatsHistory}\n     * @readonly\n     * @private\n     * @memberof MeetingStats\n     */\n    this.history = null;\n    /**\n     * @instance\n     * @type {ReadableStream}\n     * @readonly\n     * @private\n     * @memberof MeetingStats\n     */\n    this.stream = null;\n    /**\n     * @instance\n     * @type {TransformStream}\n     * @readonly\n     * @private\n     * @memberof MeetingStats\n     */\n    this.filter = null;\n    /**\n     * @instance\n     * @type {StatsEvents}\n     * @readonly\n     * @private\n     * @memberof MeetingStats\n     */\n    this.events = null;\n    /**\n     * @instance\n     * @type {String}\n     * @readonly\n     * @private\n     * @memberof MeetingStats\n     */\n    this.id = null;\n    this.populate(optionalCreateOptions);\n  }\n\n  /**\n   * @param {Object} [optionalCreateOptions]\n   * @returns {undefined}\n   * @private\n   * @memberof MeetingStats\n   */\n  populate(optionalCreateOptions) {\n    if (optionalCreateOptions) {\n      if (optionalCreateOptions.history) {\n        this.withHistory();\n      }\n      if (optionalCreateOptions.filter && !optionalCreateOptions.stream && optionalCreateOptions.media) {\n        this.withFilter(optionalCreateOptions.filter, optionalCreateOptions.media);\n      }\n      if (optionalCreateOptions.stream && !optionalCreateOptions.filter && optionalCreateOptions.media) {\n        this.withStream(optionalCreateOptions.stream, optionalCreateOptions.media);\n      }\n      if (optionalCreateOptions.id) {\n        this.withId(optionalCreateOptions.id);\n      }\n      if (optionalCreateOptions.onClose) {\n        if (!isFunction(optionalCreateOptions.onClose)) {\n          throw new TypeError('stats->populate#onClose must be a callback function for filtered data.');\n        }\n        this.onClose(optionalCreateOptions.onClose);\n      }\n      if (optionalCreateOptions.onEvent) {\n        if (!isFunction(optionalCreateOptions.onEvent)) {\n          throw new TypeError('stats->populate#onEvent must be a callback function for filtered data.');\n        }\n        if (this.history) {\n          this.withEventsHistory(this.history, optionalCreateOptions.onEvent);\n        }\n        else {\n          this.withEvents(optionalCreateOptions.onEvent);\n        }\n      }\n      if (optionalCreateOptions.onData) {\n        if (!isFunction(optionalCreateOptions.onData)) {\n          throw new TypeError('stats->populate#onData must be a callback function for filtered data.');\n        }\n        this.onData(optionalCreateOptions.onData);\n      }\n    }\n\n    return this;\n  }\n\n  /**\n   * @param {WebRTCData} data\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  doHistory(data) {\n    if (this.history) {\n      this.history.add(data);\n    }\n  }\n\n  /**\n   * @param {WebRTCData} data\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  doEvents(data) {\n    if (this.events) {\n      this.events.event(data);\n    }\n  }\n\n  /**\n   * does all the work for the built properties\n   * calls back a function with data from piped stream filter\n   * @param {Function} cbFn\n   * @returns {undefined}\n   * @throws {Error} if the filter stream does not exist\n   * @private\n   * @memberof MeetingStats\n   */\n  onData(cbFn) {\n    if (!this.filter) {\n      throw new TypeError('The stats sender/receiver filter must be set up before data can be processed.');\n    }\n    this.filter.on(STATS.DATA, (filtered) => {\n      this.doHistory(filtered);\n      this.doEvents(filtered);\n      cbFn(filtered);\n    });\n\n    return this;\n  }\n\n  /**\n   * triggered if the data stream closes\n   * calls back a function with error\n   * @param {Function} cbFn\n   * @returns {undefined}\n   * @private\n   * @memberof MeetingStats\n   */\n  onClose(cbFn) {\n    if (!this.filter) {\n      throw new TypeError('the stats sender/receiver filter must be set up before data can be closed.');\n    }\n    this.stream.on(STATS.END, (err) => {\n      if (!err) {\n        err = new StatsError(`The stats stream for id: ${this.id} ended.`);\n      }\n      cbFn(err);\n    });\n\n    return this;\n  }\n\n  /**\n   * constructs an event object on this instance\n   * @param {StatsHistory} history\n   * @param {Function} cb\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withEventsHistory(history, cb) {\n    const events = new StatsEvents(history, cb);\n\n    this.setEvents(events);\n\n    return this;\n  }\n\n  /**\n   * constructs an event object on this instance\n   * @param {Function} cb\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withEvents(cb) {\n    const events = new StatsEvents(null, cb);\n\n    this.setEvents(events);\n\n    return this;\n  }\n\n  /**\n   * constructs a history object on this instance\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withHistory() {\n    const history = new StatsHistory(this.config.stats.historyMax);\n\n    this.setHistory(history);\n\n    return this;\n  }\n\n  /**\n   * constructs a readable stream object on this instance\n   * @param {RTCRtpReceiver|RTCRtpSender} transceiverDirection\n   * @param {RTCPeerConnection} peerConnection\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withStream(transceiverDirection, peerConnection) {\n    const stream = new StatsStream({\n      rTCRtpDirection: transceiverDirection,\n      peerConnection,\n      interval: this.config.stats.interval\n    });\n\n    this.setStream(stream);\n\n    return this;\n  }\n\n  /**\n   * @param {RTCRtpReceiver|RTCRtpSender} transceiverDirection\n   * @param {RTCPeerConnection} peerConnection\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withFilter(transceiverDirection, peerConnection) {\n    this.withStream(transceiverDirection, peerConnection);\n    this.setFilter(new StatsFilter());\n    this.getStream().pipe(this.getFilter());\n\n    return this;\n  }\n\n  /**\n   * constructs an id to match this stats object\n   * takes params as precedence\n   * @param {String} id\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  withId(id) {\n    if (id) {\n      this.setId(id);\n    }\n    else {\n      this.setId(uuid.v4());\n    }\n\n    return this;\n  }\n\n  /**\n   * @returns {MeetingStats}\n   * @public\n   * @memberof MeetingStats\n   */\n  build() {\n    return this;\n  }\n\n  /**\n   * @param {String} id\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  setId(id) {\n    this.id = id;\n  }\n\n  /**\n   * @param {StatsHistory} history\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  setHistory(history) {\n    this.history = history;\n  }\n\n  /**\n   * @param {StatsEvent} events\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  setEvents(events) {\n    this.events = events;\n  }\n\n  /**\n   * @param {Readable} stream\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  setStream(stream) {\n    this.stream = stream;\n  }\n\n  /**\n   * @param {Transform} filter\n   * @returns {undefined}\n   * @public\n   * @memberof MeetingStats\n   */\n  setFilter(filter) {\n    this.filter = filter;\n  }\n\n  /**\n   * @returns {String}\n   * @public\n   * @memberof MeetingStats\n   */\n  getId() {\n    return this.id;\n  }\n\n  /**\n   * @returns {StatsHistory}\n   * @public\n   * @memberof MeetingStats\n   */\n  getHistory() {\n    return this.history;\n  }\n\n  /**\n   * @returns {StatsEvents}\n   * @public\n   * @memberof MeetingStats\n   */\n  getEvents() {\n    return this.events;\n  }\n\n  /**\n   * @returns {Readable}\n   * @public\n   * @memberof MeetingStats\n   */\n  getStream() {\n    return this.stream;\n  }\n\n  /**\n   * @returns {Transform}\n   * @public\n   * @memberof MeetingStats\n   */\n  getFilter() {\n    return this.filter;\n  }\n}\n"]}